<!doctype html>
<meta charset="utf-8">

<style>
svg text {
  font: 15px "Helvetica Neue", Helvetica, Arial, sans-serif
}

.landmass {
  stroke-width: .7;
  stroke: black;
  fill: #eee;
}

.borders {
  stroke-width: .5;
  stroke: black;
  fill: none;
}

circle {
  opacity: .8;
  stroke-width: .5;
  stroke: black;
  cursor: pointer;
}

.legend > rect {
  opacity: .8;
  fill: white;
  stroke-width: 1;
  stroke: black;
  shape-rendering: crispEdges;
}

.box rect {
  stroke-width: 1;
  stroke: #888;
  shape-rendering: crispEdges;
}

.overlay text.name {
  font-size: 18px;
}

.overlay text.total {
  font-size: 14px;
}

.overlay rect {
  fill: white;
  opacity: .9;
  stroke: #888;
}

.overlay .graph rect {
  fill: maroon;
  stroke: none;
  shape-rendering: crispEdges;
}

.overlay .axis text {
  font-size: 12px;
}

.overlay .axis path {
  fill: none;
  stroke: black;
}

.overlay .axis line {
  stroke: black;
}
</style>

<body>

<script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.1/d3.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/topojson/1.6.9/topojson.min.js"></script>
<script>
'use strict';

var country = {
  ARM: {center: [44.7,40.2], label: [42.6,38.7], name: "Armenia"},
  AZE: {center: [48.0,40.5], label: [46.6,41.4], name: "Azerbaijan"},
  BGR: {center: [25.4,42.8], label: [23.0,41.8], name: "Bulgaria"},
  BLR: {center: [28.4,53.9], label: [26.3,52.3], name: "Belarus"},
  GEO: {center: [43.5,42.0], label: [40.8,43.2], name: "Georgia"},
  MDA: {center: [28.5,47.2], label: [28.0,44.9], name: "Moldova"},
  ROU: {center: [24.8,45.9], label: [23.3,44.3], name: "Romania"},
  RUS: {center: [42.8,53.3], label: [41.8,50.4], name: "Russia"},
  TUR: {center: [37.1,39.3], label: [36.1,38.0], name: "Turkey"},
  UKR: {center: [33.6,49.2], label: [26.7,49.9], name: "Ukraine"}
}

var width = 600,
    height = width * .75;

var svg = d3.select('body').append('svg')
    .attr('width', width)
    .attr('height', height);

var projection = d3.geo.mercator()
    .translate([-0.37 * width, 1.68 * width])
    .scale(width * 1.4);

var path = d3.geo.path()
    .projection(projection);

var color = d3.scale.linear()
    .domain([0, 50])
    .range(['#ddd', '#800'])
    .interpolate(d3.interpolateHcl);

var size = function(cp100k) {
    return Math.sqrt(cp100k) * .0035 * width;
};


var landmass = svg.append('path').attr('class', 'landmass');
var borders = svg.append('path').attr('class', 'borders');
var circleGroup = svg.append('g');

d3.json('countries.topojson', function(error, topo) {
  if (error) return console.error(error);

  landmass.attr('d', path(topojson.merge(topo, topo.objects.countries.geometries)));
  borders.attr('d', path(topojson.mesh(topo, topo.objects.countries, function(a, b) {
    if(a === b) return false;
    if(country[a.properties.ADM0_A3] || country[b.properties.ADM0_A3]) return true;
    return false;
  })));
});

d3.json('data.json').get(function(error, data) {
  if (error) return console.error(error);

  d3.keys(country).forEach(function(adm0_a3) {
    country[adm0_a3].rate = data.country[adm0_a3].rate;
    country[adm0_a3].cp100kTotal = data.country[adm0_a3].cp100kTotal;
    country[adm0_a3].last10y = data.country[adm0_a3].last10y;
  });

  circleGroup.selectAll('circle')
      .data(d3.values(country))
    .enter().append('circle')
      .attr('cx', function(d) { return projection(d.center)[0]; })
      .attr('cy', function(d) { return projection(d.center)[1]; })
      .attr('r', function(d) { return size(d.cp100kTotal); })
      .attr('fill', function(d) { return color(d.rate); })
      .on('mousemove', overlay);

  svg.on('mousemove', clearOverlay);

  circleGroup.selectAll('text')
      .data(d3.values(country))
    .enter().append('text')
      .text(function(d) { return d.name })
      .attr('x', function(d) { return projection(d.label)[0]; })
      .attr('y', function(d) { return projection(d.label)[1]; });
});

var legend = svg.append('g')
    .attr('class', 'legend')
    .attr('transform', 'translate(0,' + height + ')');

legend.append('rect')
    .attr('x', -2)
    .attr('y', -.24 * height)
    .attr('height', height * .24 + 2)
    .attr('width', width * .45 + 2);

legend.append('text')
    .attr('y', -.20 * height)
    .text("HIV/AIDS cases per 100,000 population")

legend.append('text')
    .attr('y', -.14 * height)
    .text("New every year");

var legendBox = legend.selectAll('.box')
    .data([0, 20, 40])
  .enter().append('g')
    .attr('class', 'box')
    .attr('transform', function(d, i) {
        return 'translate(' + (115 + i * 50) + ',' + (-.14 * height - 15) + ')' });

legendBox.append('rect')
    .attr('width', 40)
    .attr('height', 20)
    .attr('fill', function(d) { return color(d) });

legendBox.append('text')
    .text(function(d) { return d; })
    .attr('y', 15)
    .each(function(d) { d3.select(this).attr('x', 20 - this.getBBox().width / 2) });

legend.append('text')
    .attr('y', -.07 * height)
    .text("Total");

var legendCircle = legend.selectAll('circle')
    .data([
      {cp100k: 100, x: 50},
      {cp100k: 300, x: 117},
      {cp100k: 500, x: 210}
    ])
  .enter().append('g')
    .attr('transform', function(d) {
        return 'translate(' + d.x + ',' + (-.01 * height) + ')' });

legendCircle.append('circle')
    .attr('r', function(d) { return size(d.cp100k) })
    .attr('fill', color(0));

legendCircle.append('text')
    .text(function(d) { return d.cp100k; })
    .each(function(d) { d3.select(this).attr('x', - this.getBBox().width / 2) });

function overlay(country) {
  d3.event.stopPropagation();
  clearOverlay();
  var c = projection(country.center);
  var t = [d3.min([c[0] - width * .1, width * .68]),
           d3.min([c[1] - height * .1, height * .68])];
  var overlay = svg.append('g')
      .attr('class', 'overlay')
      .attr('transform', 'translate(' + t + ')')
      .on('mousemove', function() { d3.event.stopPropagation() });

  overlay.append('rect')
      .attr('width', width * .3)
      .attr('height', height * .3);

  var x = d3.scale.ordinal().rangeRoundBands([0, width * .2], .1);

  var y = d3.scale.linear().range([height * .12, 0]);

  var xAxis = d3.svg.axis()
      .scale(x)
      .tickSize(6, 0)
      .tickValues([2005, 2009, 2013]);

  var yAxis = d3.svg.axis()
      .scale(y)
      .ticks(2)
      .orient('right');

  var years = d3.range(2004, 2014);
  var series = years.map(function(y, i) { return {year: y, value: country.last10y[i] } });
  x.domain(years);
  y.domain([0, d3.max(series, function(d) { return d.value })]);

  overlay.append('text')
      .attr('class', 'name')
      .attr('x', width * .02)
      .attr('y', height * .05)
      .text(country.name);

  overlay.append('text')
      .attr('class', 'total')
      .attr('x', width * .02)
      .attr('y', height * .10)
      .text("" + country.cp100kTotal + " cases per 100,000");

  var graph = overlay.append('g')
      .attr('class', 'graph')
      .attr('transform', 'translate(' + width * .03 + ',' + height * .12 + ')');

  graph.selectAll('rect')
      .data(series)
    .enter().append('rect')
      .attr('x', function(d) { return x(d.year) })
      .attr('y', function(d) { return y(d.value) })
      .attr('width', x.rangeBand())
      .attr('height', function(d) { return height * .12 - y(d.value) });

  graph.append('g')
      .attr('class', 'x axis')
      .attr('transform', 'translate(0,' + (height * .12) + ')')
      .call(xAxis);

  graph.append('g')
      .attr('class', 'y axis')
      .attr('transform', 'translate(' + (width * .2) + ',0)')
      .call(yAxis);
}

function clearOverlay() {
  d3.selectAll('.overlay').remove();
}

</script>
